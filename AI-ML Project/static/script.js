// Icon SVG functions (converted from Lucide-React) - These are still here but not used in nav buttons
const CalendarIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2V5" /><path d="M16 2V5" /><path d="M21 8V21a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2Z" /><path d="M3 12H21" /></svg>`;
const TrendingUpIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17" /><polyline points="16 7 22 7 22 13" /></polyline></svg>`;
const TrendingDownIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><polyline points="22 17 13.5 8.5 8.5 13.5 2 7" /><polyline points="16 17 22 17 22 11" /></polyline></svg>`;
const CloudSunIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M2 12h2"/><path d="M4.93 19.07l1.41-1.41"/><path d="M12 22v-2"/><path d="m19.07 19.07-1.41-1.41"/><path d="M22 12h-2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/><path d="M20 16.5A4.5 4.5 0 0 0 15.5 12H12a2 2 0 0 0-2 2.5v0A2.5 2.5 0 0 1 7.5 17H5a2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h13.5a3.5 3.5 0 0 0 3.5-3.5Z"/></svg>`;
const ActivityIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></svg>`;
const TargetIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><circle cx="12" cy="12" r="10" /><circle cx="12" cy="12" r="6" /><circle cx="12" cy="12" r="2" /></svg>`;
const LightbulbIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 3c0 1.3.5 2.6 1.5 3.5.8.8 1.3 1.5 1.5 2.5" /><path d="M9 18h6" /><path d="M10 22h4" /><path d="M11 17v5" /></svg>`;
const LoaderIcon = (className = "") => `<svg class="animate-spin ${className}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>`;
const InfoIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>`;
const BrainIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><path d="M9.5 8A2.5 2.5 0 0 1 12 5.5a2.5 2.5 0 0 1 2.5 2.5v3.52L12 14 9.5 11.52Z"/><path d="M12 14v7.5"/><path d="M12 14H6.4c-2.3 0-3.3-1-3.3-2.7V10c0-1.7 1-2.7 3.3-2.7h.6"/><path d="M12 14h5.6c2.3 0 3.3-1 3.3-2.7V10c0-1.7-1-2.7-3.3-2.7h-.6"/><path d="M8.5 2C10.4 3.1 11 5 11 5.5 11 6 10.4 6.9 8.5 8"/><path d="M15.5 2C13.6 3.1 13 5 13 5.5 13 6 13.6 6.9 15.5 8"/><path d="M11 20.5c-5.1-.5-9-4.7-9-9.5"/><path d="M22 11c0 4.8-3.9 9-9 9.5"/></svg>`;
const DollarSignIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></svg>`;
const LineChartIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><path d="M3 3v18h18" /><path d="m18 6-6 6-4-4-3 3" /></svg>`;
const BarChartIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><line x1="12" x2="12" y1="20" y2="10" /><line x1="18" x2="18" y1="20" y2="4" /><line x1="6" x2="6" y1="20" y2="16" /></svg>`;
const NewspaperIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h2" /><path d="M18 14h-8" /><path d="M18 18h-8" /><path d="M10 8h4" /></svg>`;
const SparklesIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><path d="M9.9 10.8c.1.7.3 1.4.6 2.1.3.7.7 1.3 1.2 1.8.5.5 1.1.9 1.8 1.2.7.3 1.4.5 2.1.6.7.1 1.4.1 2.1.1.7 0 1.4-.1 2.1-.2.7-.1 1.4-.3 2.1-.6.7-.3 1.3-.7 1.8-1.2.5-.5.9-1.1 1.2-1.8.3-.7.5-1.4.6-2.1.1-.7.1-1.4.1-2.1 0-.7-.1-1.4-.2-2.1-.1-.7-.3-1.4-.6-2.1-.3-.7-.7-1.3-1.2-1.8-.5-.5-1.1-.9-1.8-1.2-.7-.3-1.4-.5-2.1-.6-.7-.1-1.4-.1-2.1-.1-.7 0-1.4.1-2.1.2-.7.1-1.4.3-2.1.6-.7.3-1.3.7-1.8 1.2-.5.5-.9 1.1-1.2 1.8-.3.7-.5 1.4-.6 2.1-.1.7-.1 1.4-.1 2.1 0 .7.1 1.4.2 2.1Z"/><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M2 12h2"/><path d="M4.93 19.07l1.41-1.41"/><path d="M12 22v-2"/><path d="m19.07 19.07-1.41-1.41"/><path d="M22 12h-2"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;
const AlertTriangleIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`;
const CheckCircleIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></polyline></svg>`;
const LayoutDashboardIcon = (className = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>`;


// Global state variables
let category = ''; // Initial category to empty string
let item = '';
let forecastDate = '';
let predictionPeriod = ''; // Initial predictionPeriod to empty string
let selectedSeason = ''; // Initial selectedSeason to empty string
let forecastResult = null;
let llmInsight = '';
let loadingForecast = false;
let loadingInsight = false;
let showError = false;
let errorMessage = '';
let chartData = [];
let currentPrices = [];
let loadingCurrentPrices = true;
let currentPage = 'dashboard';
let priceChart = null; // To hold the Chart.js instance

// --- Authentication State ---
let isUserSignedIn = false; // Tracks if the user is currently signed in
// --- End Authentication State ---


// Define pulses and vegetables with basePrice, volatility, and typicalSeason for local simulation
const pulses = [
    { name: 'Toor Dal', 'basePrice': 90, 'volatility': 0.08 },
    { name: 'Moong Dal', 'basePrice': 75, 'volatility': 0.06 },
    { name: 'Masoor Dal', 'basePrice': 80, 'volatility': 0.07 },
    { name: 'Chana Dal', 'basePrice': 65, 'volatility': 0.05 },
];

const vegetables = [
    { name: 'Potatoes', 'basePrice': 25, 'volatility': 0.15 },
    { name: 'Onions', 'basePrice': 30, 'volatility': 0.20 },
    { name: 'Tomatoes', 'basePrice': 40, 'volatility': 0.25 },
    { name: 'Cabbage', 'basePrice': 20, 'volatility': 0.10 },
];

// Seasons data
const seasons = [
    { name: 'Spring', months: 'Mar-May', impact: 'harvest' },
    { name: 'Summer', months: 'Jun-Aug', impact: 'heat_stress' },
    { name: 'Monsoon', months: 'Sep-Nov', impact: 'planting' },
    { name: 'Winter', months: 'Dec-Feb', impact: 'storage' },
];

// Define a palette of background colors for the item name placeholders
const backgroundColors = [
    'bg-blue-200', 'bg-green-200', 'bg-purple-200', 'bg-red-200',
    'bg-yellow-200', 'bg-indigo-200', 'bg-pink-200', 'bg-teal-200'
];
const textColors = [
    'text-blue-800', 'text-green-800', 'text-purple-800', 'text-red-800',
    'text-yellow-800', 'text-indigo-800', 'text-pink-800', 'text-teal-800'
];

// Helper function to get a consistent color based on item name
function getItemColorClasses(itemName) {
    let hash = 0;
    for (let i = 0; i < itemName.length; i++) {
        hash = itemName.charCodeAt(i) + ((hash << 5) - hash);
    }
    const colorIndex = Math.abs(hash % backgroundColors.length);
    return `${backgroundColors[colorIndex]} ${textColors[colorIndex]}`;
}

// Helper function to show toast messages
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `p-4 rounded-lg shadow-lg flex items-center space-x-3 text-white toast-enter`;
    toast.style.minWidth = '250px'; // Ensure toast has a minimum width

    let bgColorClass = '';
    let iconSvg = '';
    if (type === 'success') {
        bgColorClass = 'bg-green-500';
        iconSvg = CheckCircleIcon('h-6 w-6');
    } else if (type === 'error') {
        bgColorClass = 'bg-red-500';
        iconSvg = AlertTriangleIcon('h-6 w-6');
    } else {
        bgColorClass = 'bg-blue-500';
        iconSvg = InfoIcon('h-6 w-6');
    }

    toast.classList.add(bgColorClass);
    toast.innerHTML = `
        ${iconSvg}
        <span class="font-medium">${message}</span>
    `;

    toastContainer.appendChild(toast);

    // Automatically remove toast after 3 seconds with animation
    setTimeout(() => {
        toast.classList.remove('toast-enter');
        toast.classList.add('toast-exit');
        toast.addEventListener('animationend', () => toast.remove(), { once: true });
    }, 3000);
}


// Helper function to simulate LLM API call
async function getLLMInsight(item, forecastedPrice, predictionPeriod, selectedSeasonData) {
    let seasonalText = '';
    if (selectedSeasonData && selectedSeasonData.name !== '') {
        seasonalText = ` During ${selectedSeasonData.name} season (${selectedSeasonData.months}), expect ${selectedSeasonData.impact.replace('_', ' ')} related price variations.`
    }
    const prompt = `Advanced market analysis indicates ${item} prices will show ${forecastedPrice > 0 ? 'upward' : 'downward'} momentum. Key factors include seasonal patterns, supply chain dynamics, weather conditions, and regional demand fluctuations.${seasonalText} Current market volatility is calculated based on historical data. Monitor government policies, export demands, and storage costs for additional price impacts.`;

    let chatHistory = [];
    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
    const payload = { contents: chatHistory };
    const apiKey = ""; // Canvas will provide this at runtime for frontend calls
    const apiUrl = `http://127.0.0.1:5000`; // Assuming your Flask backend is running here

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            return result.candidates[0].content.parts[0].text;
        } else {
            console.error("LLM response structure unexpected:", result);
            return "No specific insights available at this time.";
        }
    } catch (error) {
        console.error("Error calling LLM API:", error);
        return "Failed to generate market insights due to an API error.";
    }
}

// Simulate current market prices
function generateCurrentPrices() {
    const allProduce = [...pulses, ...vegetables];
    return allProduce.map(p => ({
        item: p.name,
        price: parseFloat((p.basePrice * (1 + (Math.random() - 0.5) * p.volatility * 0.5)).toFixed(2))
    }));
}

// Generate simulated historical and forecast data for the chart
function generateChartData(selectedItem, selectedDate, period) {
    if (!selectedItem || !selectedDate) return [];

    const today = new Date();
    const forecastDt = new Date(selectedDate);
    const data = [];

    // Simulate historical data for the past 30 days
    for (let i = 30; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const price = selectedItem.basePrice * (1 + (Math.random() - 0.5) * selectedItem.volatility);
        data.push({
            date: date.toISOString().split('T')[0],
            price: parseFloat(price.toFixed(2)),
            type: 'Historical'
        });
    }

    // Determine forecast days based on predictionPeriod
    let forecastDays = 0;
    switch (period) {
        case '1 Week':
            forecastDays = 7;
            break;
        case '2 Weeks':
            forecastDays = 14;
            break;
        case '1 Month':
            forecastDays = 30;
            break;
        case '3 Months':
            forecastDays = 90;
            break;
        case '6 Months':
            forecastDays = 180;
            break;
        case '1 Year':
            forecastDays = 365;
            break;
        default:
            forecastDays = 7;
    }

    // Simulate forecast data for the selected prediction period
    const lastHistoricalPrice = data[data.length - 1].price;
    for (let i = 0; i <= forecastDays; i++) {
        const date = new Date(forecastDt);
        date.setDate(forecastDt.getDate() + i);
        // Simple linear trend for forecast, with some noise
        const trendFactor = (forecastDt.getTime() - today.getTime()) / (1000 * 60 * 60 * 24 * 30); // Normalize by 30 days
        const forecastPrice = lastHistoricalPrice * (1 + (trendFactor * 0.05) + (Math.random() - 0.5) * selectedItem.volatility * 0.5);
        data.push({
            date: date.toISOString().split('T')[0],
            price: parseFloat(forecastPrice.toFixed(2)),
            type: 'Forecast'
        });
    }
    return data;
}

// Function to simulate price forecasting and generate insights
async function simulateForecast() {
    console.log("simulateForecast called."); // Debugging
    // === START: Google Sign-in Check ===
    const googleIdToken = sessionStorage.getItem("id_token"); // Checks if a Google ID token exists in session storage
    console.log("ID Token from sessionStorage (simulateForecast):", googleIdToken); // Debugging
    if (!googleIdToken) { // If no token is found (user not signed in via Google)
        showToast("Please sign in with Google to predict price.", 'error'); // Displays the custom error toast message
        console.log("Prediction blocked: User not signed in via Google."); // Debugging
        return; // Stops the function execution here, preventing prediction
    }
    // === END: Google Sign-in Check ===

    if (!category || category === '') {
        showToast("Please select a category.", 'error');
        return;
    }
    if (!item || item === '') {
        showToast("Please select a commodity.", 'error');
        return;
    }
    if (!selectedSeason || selectedSeason === '') {
        showToast("Please select a season.", 'error');
        return;
    }
    if (!forecastDate || forecastDate === '') {
        showToast("Please select a forecast date.", 'error');
        return;
    }
    if (!predictionPeriod || predictionPeriod === '') {
        showToast("Please select a prediction period.", 'error');
        return;
    }
    console.log("Proceeding with prediction. User is signed in."); // Debugging

    loadingForecast = true;
    loadingInsight = true;
    setShowError(false); // Hide any existing error modal
    forecastResult = null;
    llmInsight = '';
    chartData = [];
    updateUI(); // Update UI to show loading states

    const selectedProduceList = category === 'pulses' ? pulses : vegetables;
    const selectedProduce = selectedProduceList.find(p => p.name === item);
    const currentSeasonData = seasons.find(s => s.name === selectedSeason); // Get selected season data

    if (!selectedProduce) {
        setErrorMessage("Selected item not found.");
        setShowError(true);
        loadingForecast = false;
        loadingInsight = false;
        updateUI();
        return;
    }

    const generatedData = generateChartData(selectedProduce, forecastDate, predictionPeriod);
    chartData = generatedData;

    // Find the forecasted price for the exact forecastDate
    const specificForecastPoint = generatedData.find(d => d.date === forecastDate);
    const finalForecastPrice = specificForecastPoint ? specificForecastPoint.price : generatedData[generatedData.length - 1].price; // Fallback to last forecast point

    // Simulate network delay
    await new Promise(resolve => setTimeout(resolve, 1500));

    forecastResult = {
        item: item,
        date: forecastDate,
        price: finalForecastPrice,
        unit: 'â‚¹/kg',
        trend: finalForecastPrice > selectedProduce.basePrice ? 'Upward' : 'Downward',
        confidence: `${Math.floor(70 + Math.random() * 20)}%`,
        season: currentSeasonData ? currentSeasonData.name : 'Not specified',
        seasonalImpact: currentSeasonData ? currentSeasonData.impact : 'neutral'
    };
    loadingForecast = false;
    updateUI(); // Update UI after forecast

    // Get LLM insight
    const insight = await getLLMInsight(item, finalForecastPrice, predictionPeriod, currentSeasonData);
    llmInsight = insight;
    loadingInsight = false;
    updateUI(); // Update UI after insight

    showToast("Price prediction generated successfully!", 'success');
}


function setShowError(value) {
    showError = value;
    const errorModal = document.getElementById('error-modal');
    const errorModalContent = document.getElementById('error-modal-content');
    if (value) {
        errorModal.classList.remove('hidden');
        setTimeout(() => {
            errorModalContent.classList.remove('scale-95', 'opacity-0');
            errorModalContent.classList.add('scale-100', 'opacity-100');
        }, 10); // Small delay to trigger transition
    } else {
        errorModalContent.classList.remove('scale-100', 'opacity-100');
        errorModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            errorModal.classList.add('hidden');
        }, 300); // Match transition duration
    }
}

function setErrorMessage(message) {
    errorMessage = message;
    document.getElementById('error-message').textContent = errorMessage;
}

function closeErrorModal() {
    setShowError(false);
    setErrorMessage('');
}

// Function to render the chart using Chart.js
function renderChart() {
    const ctx = document.getElementById('priceChartCanvas');
    if (!ctx) return; // Ensure canvas exists

    // Destroy existing chart instance if it exists
    if (priceChart) {
        priceChart.destroy();
    }

    if (chartData.length === 0) {
        ctx.style.display = 'none'; // Hide canvas if no data
        return;
    } else {
        ctx.style.display = 'block'; // Show canvas if data exists
    }

    priceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(d => new Date(d.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' })),
            datasets: [{
                label: 'Price (â‚¹/kg)',
                data: chartData.map(d => d.price),
                borderColor: '#10B981', // Green-600
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                borderWidth: 2,
                pointRadius: 0, // Hide points by default
                pointHoverRadius: 6, // Show point on hover
                fill: false,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    enabled: true, // Ensure tooltips are enabled
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            const dataPoint = chartData[context.dataIndex];
                            return `Price: â‚¹${context.raw.toFixed(2)} (${dataPoint.type})`;
                        },
                        title: function(context) {
                            // Format date for tooltip title
                            const date = new Date(chartData[context[0].dataIndex].date);
                            return date.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Price (â‚¹/kg)'
                    },
                    beginAtZero: false
                }
            }
        }
    });
}

// Helper for getting seasonal impact color
function getSeasonalImpactColor(impact) {
    switch (impact) {
        case 'harvest': return 'text-green-600 bg-green-100';
        case 'heat_stress': return 'text-red-600 bg-red-100';
        case 'planting': return 'text-blue-600 bg-blue-100';
        case 'storage': return 'text-purple-600 bg-purple-100';
        default: return 'text-gray-600 bg-gray-100';
    }
}

// Function to render the main content based on currentPage
function renderContent() {
    const mainContentDiv = document.getElementById('main-content');
    let html = '';

    const pulsesPrices = currentPrices.filter(p => pulses.some(item => item.name === p.item));
    const vegetablesPrices = currentPrices.filter(p => vegetables.some(item => item.name === p.item));

    const selectedProduceList = category === 'pulses' ? pulses : vegetables;
    const itemOptions = selectedProduceList.map(p => `<option value="${p.name}" ${item === p.name ? 'selected' : ''}>${p.name}</option>`).join('');
    const seasonOptions = seasons.map(s => `<option value="${s.name}" ${selectedSeason === s.name ? 'selected' : ''}>${s.name} (${s.months})</option>`).join('');


    switch (currentPage) {
        case 'dashboard':
            html = `
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mt-8">
                    <div class="xl:col-span-1 bg-gradient-to-br from-white via-emerald-50 to-teal-50 border-emerald-300 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-[1.02] card-animate">
                        <div class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-t-lg p-4">
                            <h2 class="text-2xl font-bold flex items-center gap-3">
                                ${TrendingUpIcon('h-7 w-7 animate-pulse')}
                                AI Price Prediction
                            </h2>
                        </div>
                        <div class="space-y-6 p-6">
                            <div>
                                <label for="category-select" class="block text-lg font-semibold text-gray-700">Select Category</label>
                                <select id="category-select" class="mt-2 w-full p-3 border-2 border-emerald-200 rounded-lg shadow-sm focus:border-emerald-500 bg-white/80 backdrop-blur-sm input-focus-effect">
                                    <option value="" ${category === '' ? 'selected' : ''}>--select category--</option>
                                    <option value="pulses" ${category === 'pulses' ? 'selected' : ''}>ðŸ«˜ Pulses</option>
                                    <option value="vegetables" ${category === 'vegetables' ? 'selected' : ''}>ðŸ¥¬ Vegetables</option>
                                </select>
                            </div>

                            <div>
                                <label for="item-select" class="block text-lg font-semibold text-gray-700">Select Commodity</label>
                                <select id="item-select" class="mt-2 w-full p-3 border-2 border-emerald-200 rounded-lg shadow-sm focus:border-emerald-500 bg-white/80 backdrop-blur-sm input-focus-effect">
                                    <option value="" ${item === '' ? 'selected' : ''}>--select commodities--</option>
                                    ${itemOptions}
                                </select>
                            </div>

                            <div>
                                <label for="season-select" class="block text-lg font-semibold text-gray-700">Select Season</label>
                                <select id="season-select" class="mt-2 w-full p-3 border-2 border-emerald-200 rounded-lg shadow-sm focus:border-emerald-500 bg-white/80 backdrop-blur-sm input-focus-effect">
                                    <option value="" ${selectedSeason === '' ? 'selected' : ''}>--select season--</option>
                                    ${seasonOptions}
                                </select>
                            </div>

                            <div>
                                <label for="forecastDate-input" class="block text-lg font-semibold text-gray-700">Forecast Start Date</label>
                                <div class="relative mt-2">
                                    <input type="date" id="forecastDate-input" value="${forecastDate}" class="w-full p-3 border-2 border-emerald-200 rounded-lg shadow-sm focus:border-emerald-500 bg-white/80 backdrop-blur-sm pr-12 input-focus-effect" />
                                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-emerald-500">
                                        ${CalendarIcon()}
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label for="predictionPeriod-select" class="block text-lg font-semibold text-gray-700">Prediction Period</label>
                                <select id="predictionPeriod-select" class="mt-2 w-full p-3 border-2 border-emerald-200 rounded-lg shadow-sm focus:border-emerald-500 bg-white/80 backdrop-blur-sm input-focus-effect">
                                    <option value="" ${predictionPeriod === '' ? 'selected' : ''}>--select period--</option>
                                    <option value="1 Week" ${predictionPeriod === '1 Week' ? 'selected' : ''}>ðŸ“… 1 Week</option>
                                    <option value="2 Weeks" ${predictionPeriod === '2 Weeks' ? 'selected' : ''}>ðŸ“… 2 Weeks</option>
                                    <option value="1 Month" ${predictionPeriod === '1 Month' ? 'selected' : ''}>ðŸ“… 1 Month</option>
                                    <option value="3 Months" ${predictionPeriod === '3 Months' ? 'selected' : ''}>ðŸ“… 3 Months</option>
                                    <option value="6 Months" ${predictionPeriod === '6 Months' ? 'selected' : ''}>ðŸ“… 6 Months</option>
                                    <option value="1 Year" ${predictionPeriod === '1 Year' ? 'selected' : ''}>ðŸ“… 1 Year</option>
                                </select>
                            </div>

                            <button id="generate-forecast-btn" class="w-full bg-gradient-to-r from-emerald-600 via-teal-600 to-cyan-600 hover:from-emerald-700 hover:via-teal-700 hover:to-cyan-700 text-white font-bold py-4 h-14 shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-105 text-lg btn-hover-effect flex items-center justify-center space-x-3 flex-nowrap ${loadingForecast || loadingInsight ? 'opacity-50 cursor-not-allowed' : ''}" ${loadingForecast || loadingInsight ? 'disabled' : ''}>
                                ${loadingForecast ? `
                                    ${LoaderIcon('h-6 w-6 flex-shrink-0')}
                                    <span class="whitespace-nowrap">Generating AI Prediction...</span>
                                ` : `
                                    ${TrendingUpIcon('h-6 w-6 flex-shrink-0')}
                                    <span class="whitespace-nowrap">Generate Price Prediction</span>
                                `}
                            </button>
                        </div>
                    </div>

                    <div class="xl:col-span-2 space-y-8">
                        <div class="bg-gradient-to-br from-white via-orange-50 to-yellow-50 border-orange-300 shadow-2xl card-animate">
                            <div class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white rounded-t-lg p-4">
                                <h2 class="text-2xl font-bold flex items-center gap-3">
                                    ${DollarSignIcon()}
                                    Current Market Prices (Simulated)
                                </h2>
                            </div>
                            <div class="p-6">
                                ${loadingCurrentPrices ? `
                                    <div class="col-span-full text-center text-gray-500 flex items-center justify-center py-4">
                                        ${LoaderIcon('h-5 w-5 mr-2')}
                                        <span>Loading current prices...</span>
                                    </div>
                                ` : currentPrices.length > 0 ? `
                                    <h3 class="text-xl font-semibold text-yellow-800 mb-4">Pulses</h3>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                        ${pulsesPrices.map((data, index) => `
                                            <div class="flex items-center bg-yellow-100 p-3 rounded-lg shadow-sm">
                                                <span class="w-12 h-12 rounded-full flex items-center justify-center text-center text-xs font-semibold mr-4 border border-yellow-300 ${getItemColorClasses(data.item)}">
                                                    ${data.item}
                                                </span>
                                                <div class="flex-grow">
                                                    <span class="font-medium text-gray-700 block">${data.item}</span>
                                                    <span class="font-semibold text-yellow-700">â‚¹${data.price.toFixed(2)}/kg</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>

                                    <h3 class="text-xl font-semibold text-yellow-800 mb-4">Vegetables</h3>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                        ${vegetablesPrices.map((data, index) => `
                                            <div class="flex items-center bg-yellow-100 p-3 rounded-lg shadow-sm">
                                                <span class="w-12 h-12 rounded-full flex items-center justify-center text-center text-xs font-semibold mr-4 border border-yellow-300 ${getItemColorClasses(data.item)}">
                                                    ${data.item}
                                                </span>
                                                <div class="flex-grow">
                                                    <span class="font-medium text-gray-700 block">${data.item}</span>
                                                    <span class="font-semibold text-yellow-700">â‚¹${data.price.toFixed(2)}/kg</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="col-span-full text-center text-gray-500">No current price data available.</div>
                                `}
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-white via-blue-50 to-cyan-50 border-blue-300 shadow-2xl h-96 flex flex-col card-animate">
                            <div class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-t-lg p-4">
                                <h2 class="text-2xl font-bold flex items-center gap-3">
                                    ${LineChartIcon()}
                                    Price Trend (Historical & Forecast)
                                </h2>
                            </div>
                            <div class="p-6 flex-grow flex items-center justify-center">
                                ${loadingForecast ? `
                                    <div class="flex items-center justify-center h-full text-blue-600">
                                        ${LoaderIcon('h-8 w-8 mr-3')}
                                        <span>Loading chart data...</span>
                                    </div>
                                ` : chartData.length > 0 ? `
                                    <div style="width: 100%; height: 100%;"><canvas id="priceChartCanvas"></canvas></div>
                                ` : `
                                    <div class="flex flex-col items-center justify-center h-full text-gray-500">
                                        ${InfoIcon('h-16 w-16 text-blue-300 mb-4')}
                                        <span class="text-lg mb-2">Select an item and date, then click 'Generate Price Prediction'</span>
                                        <span class="text-sm">to see the historical and forecasted price trend.</span>
                                    </div>
                                `}
                            </div>
                        </div>

                        ${forecastResult ? `
                            <div class="bg-gradient-to-br from-white to-green-50 border-green-200 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-[1.02] animate-fade-in card-animate">
                                <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-t-lg p-4">
                                    <h2 class="text-2xl font-bold flex items-center gap-3">
                                        ${forecastResult.trend === 'Upward' ? TrendingUpIcon('h-7 w-7 text-green-300 animate-pulse') : TrendingDownIcon('h-7 w-7 text-red-300 animate-pulse')}
                                        Enhanced Forecast Analysis for ${forecastResult.item}
                                        <div class="ml-auto">
                                            ${ActivityIcon('h-6 w-6 animate-pulse')}
                                        </div>
                                    </h2>
                                </div>
                                <div class="p-8">
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                        <div class="lg:col-span-2 space-y-6">
                                            <div class="bg-gradient-to-r from-green-100 to-emerald-100 p-6 rounded-2xl border-2 border-green-200">
                                                <div class="flex items-center justify-between mb-4">
                                                    <div>
                                                        <p class="text-sm font-medium text-gray-600 mb-1 flex items-center gap-2">
                                                            ${CalendarIcon()}
                                                            Forecast Date
                                                        </p>
                                                        <p class="text-xl font-bold text-gray-800">${forecastResult.date}</p>
                                                    </div>
                                                    <div>
                                                        <p class="text-sm font-medium text-gray-600 mb-1 flex items-center gap-2">
                                                            ${TargetIcon()}
                                                            Price Trend
                                                        </p>
                                                        <div class="flex items-center gap-2">
                                                            ${forecastResult.trend === 'Upward' ? TrendingUpIcon('h-5 w-5 text-green-600') : TrendingDownIcon('h-5 w-5 text-red-600')}
                                                            <span class="text-lg font-bold ${forecastResult.trend === 'Upward' ? 'text-green-600' : 'text-red-600'}">
                                                                ${forecastResult.trend}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="text-center">
                                                    <p class="text-sm font-medium text-gray-600 mb-2">Predicted Market Price</p>
                                                    <div class="flex items-center justify-center">
                                                        <span class="text-6xl font-bold text-green-700">
                                                            â‚¹${forecastResult.price.toFixed(2)}
                                                        </span>
                                                        <span class="text-2xl font-medium text-gray-600 ml-3">
                                                            ${forecastResult.unit}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            ${forecastResult.season && forecastResult.season !== 'Not specified' ? `
                                                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-6 rounded-2xl border-2 border-blue-200">
                                                    <div class="flex items-center justify-between">
                                                        <div>
                                                            <p class="text-sm font-medium text-gray-600 mb-1 flex items-center gap-2">
                                                                ${CloudSunIcon()}
                                                                Season Context
                                                            </p>
                                                            <p class="text-xl font-bold text-blue-800">${forecastResult.season}</p>
                                                        </div>
                                                        <div>
                                                            <p class="text-sm font-medium text-gray-600 mb-1">Seasonal Impact</p>
                                                            <span class="px-3 py-1 rounded-full text-sm font-bold ${getSeasonalImpactColor(forecastResult.seasonalImpact || 'neutral')}">
                                                                ${(forecastResult.seasonalImpact || 'NEUTRAL').replace('_', ' ').toUpperCase()}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>

                                        <div class="space-y-6">
                                            <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-2xl border-2 border-purple-200">
                                                <p class="text-sm font-medium text-gray-600 mb-2">Confidence Level</p>
                                                <div class="flex items-center gap-3">
                                                    <div class="flex-1 bg-gray-200 rounded-full h-3">
                                                        <div
                                                            class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-1000"
                                                            style="width: ${forecastResult.confidence}"
                                                        ></div>
                                                    </div>
                                                    <span class="text-lg font-bold text-purple-600">${forecastResult.confidence}</span>
                                                </div>
                                            </div>

                                            <div class="bg-gradient-to-br from-orange-50 to-yellow-50 p-6 rounded-2xl border-2 border-orange-200">
                                                <p class="text-sm font-medium text-gray-600 mb-3">Market Indicators</p>
                                                <div class="space-y-3">
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-sm text-gray-600">Volatility</span>
                                                        <span class="font-semibold text-orange-600">Medium</span>
                                                    </div>
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-sm text-gray-600">Demand</span>
                                                        <span class="font-semibold text-green-600">Strong</span>
                                                    </div>
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-sm text-gray-600">Supply</span>
                                                        <span class="font-semibold text-blue-600">Stable</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="bg-gradient-to-br from-gray-50 to-slate-50 p-6 rounded-2xl border-2 border-gray-200">
                                                <p class="text-sm font-medium text-gray-600 mb-3">Risk Assessment</p>
                                                <div class="space-y-2">
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                                        <span class="text-sm text-gray-700">Weather conditions favorable</span>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                                                        <span class="text-sm text-gray-700">Monitor policy changes</span>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                                        <span class="text-sm text-gray-700">Export demand steady</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="bg-gradient-to-br from-white to-purple-50 border-purple-300 shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:scale-[1.01] card-animate">
                            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-t-lg p-4">
                                <h2 class="text-2xl font-bold flex items-center gap-3">
                                    ${BrainIcon('h-7 w-7 animate-pulse')}
                                    AI-Powered Market Intelligence
                                    <div class="ml-auto flex items-center space-x-2">
                                        ${LightbulbIcon('h-6 w-6 animate-pulse text-yellow-300')}
                                        <span class="text-sm font-medium">Advanced Analytics</span>
                                    </div>
                                </h2>
                            </div>
                            <div class="p-8">
                                ${loadingInsight ? `
                                    <div class="flex flex-col items-center justify-center py-12 text-purple-600">
                                        <div class="relative">
                                            ${LoaderIcon('h-12 w-12 animate-spin')}
                                            <div class="absolute inset-0 h-12 w-12 animate-ping opacity-20">
                                                ${BrainIcon('h-12 w-12')}
                                            </div>
                                        </div>
                                        <span class="text-lg font-medium mt-4">Analyzing market patterns...</span>
                                        <span class="text-sm text-gray-500 mt-2">Processing AI insights and trends</span>
                                    </div>
                                ` : llmInsight ? `
                                    <div class="space-y-6">
                                        <div class="bg-gradient-to-r from-purple-100 to-indigo-100 p-6 rounded-2xl border-2 border-purple-200">
                                            <div class="flex items-start gap-4">
                                                <div class="p-2 bg-purple-500 rounded-lg">
                                                    ${LightbulbIcon('h-6 w-6 text-white')}
                                                </div>
                                                <div class="flex-1">
                                                    <h3 class="text-lg font-bold text-purple-800 mb-3">Strategic Market Analysis</h3>
                                                    <p class="text-gray-700 leading-relaxed">${llmInsight}</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-5 rounded-xl border-2 border-green-200">
                                                <div class="flex items-center gap-3 mb-3">
                                                    ${TrendingUpIcon('h-5 w-5 text-green-600')}
                                                    <h4 class="font-bold text-green-800">Market Momentum</h4>
                                                </div>
                                                <p class="text-sm text-gray-700">
                                                    Current market trends indicate positive momentum with stable supply chains and consistent demand patterns.
                                                </p>
                                            </div>

                                            <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-5 rounded-xl border-2 border-yellow-200">
                                                <div class="flex items-center gap-3 mb-3">
                                                    ${AlertTriangleIcon('h-5 w-5 text-yellow-600')}
                                                    <h4 class="font-bold text-yellow-800">Risk Factors</h4>
                                                </div>
                                                <p class="text-sm text-gray-700">
                                                    Monitor weather conditions, policy changes, and global commodity prices for potential market impacts.
                                                </p>
                                            </div>

                                            <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-5 rounded-xl border-2 border-blue-200">
                                                <div class="flex items-center gap-3 mb-3">
                                                    ${InfoIcon('h-5 w-5 text-blue-600')}
                                                    <h4 class="font-bold text-blue-800">Recommendations</h4>
                                                </div>
                                                <p class="text-sm text-gray-700">
                                                    Consider seasonal variations and market timing for optimal trading decisions and inventory management.
                                                </p>
                                            </div>
                                        </div>

                                        ${llmInsight.split('.').filter(s => s.trim().length > 0).length > 1 ? `
                                            <div class="bg-gradient-to-r from-gray-50 to-slate-50 p-6 rounded-2xl border-2 border-gray-200">
                                                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                                    ${BrainIcon('h-5 w-5')}
                                                    Detailed Analysis Breakdown
                                                </h3>
                                                <div class="space-y-3">
                                                    ${llmInsight.split('.').filter(s => s.trim().length > 0).slice(0, 3).map((section, index) => `
                                                        <div class="flex items-start gap-3">
                                                            <div class="w-6 h-6 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center font-bold">
                                                                ${index + 1}
                                                            </div>
                                                            <p class="text-sm text-gray-700 leading-relaxed">${section}.</p>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}

                                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-2xl border-2 border-indigo-200">
                                            <h3 class="text-lg font-bold text-indigo-800 mb-4">Analysis Confidence Metrics</h3>
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                <div class="text-center">
                                                    <div class="text-2xl font-bold text-green-600">85%</div>
                                                    <div class="text-xs text-gray-600">Data Accuracy</div>
                                                </div>
                                                <div class="text-center">
                                                    <div class="text-2xl font-bold text-blue-600">92%</div>
                                                    <div class="text-xs text-gray-600">Model Reliability</div>
                                                </div>
                                                <div class="text-center">
                                                    <div class="text-2xl font-bold text-purple-600">78%</div>
                                                    <div class="text-xs text-gray-600">Trend Prediction</div>
                                                </div>
                                                <div class="text-center">
                                                    <div class="text-2xl font-bold text-orange-600">88%</div>
                                                    <div class="text-xs text-gray-600">Market Correlation</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="text-center py-12">
                                        <div class="mb-4">
                                            ${BrainIcon('h-16 w-16 text-purple-300 mx-auto')}
                                        </div>
                                        <p class="text-gray-500 italic text-lg mb-2">
                                            AI market intelligence awaits your price prediction
                                        </p>
                                        <p class="text-sm text-gray-400">
                                            Generate a forecast to unlock comprehensive market insights and analysis
                                        </p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'markets':
            html = `
                <div class="space-y-8 animate-fade-in">
                    <div class="bg-gradient-to-br from-white via-orange-50 to-yellow-50 border-orange-300 shadow-2xl card-animate">
                        <div class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white rounded-t-lg p-4">
                            <h2 class="text-3xl font-bold flex items-center gap-3">
                                ${DollarSignIcon()}
                                Live Market Overview
                                <div class="ml-auto flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-green-400 rounded-full animate-ping"></div>
                                    <span class="text-sm font-medium">Live</span>
                                </div>
                            </h2>
                        </div>
                        <div class="p-6">
                            <p class="text-xl text-gray-700 mb-8 font-medium">
                                ðŸŒ¾ Explore real-time market prices for premium agricultural commodities
                            </p>
                            ${loadingCurrentPrices ? `
                                <div class="col-span-full text-center text-gray-500 flex items-center justify-center py-4">
                                    ${LoaderIcon('h-5 w-5 mr-2')}
                                    <span>Loading current prices...</span>
                                </div>
                            ` : currentPrices.length > 0 ? `
                                <h3 class="text-xl font-semibold text-yellow-800 mb-4">Pulses</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                    ${pulsesPrices.map((data, index) => `
                                        <div class="flex items-center bg-yellow-100 p-3 rounded-lg shadow-sm">
                                            <span class="w-12 h-12 rounded-full flex items-center justify-center text-center text-xs font-semibold mr-4 border border-yellow-300 ${getItemColorClasses(data.item)}">
                                                ${data.item}
                                            </span>
                                            <div class="flex-grow">
                                                <span class="font-medium text-gray-700 block">${data.item}</span>
                                                <span class="font-semibold text-yellow-700">â‚¹${data.price.toFixed(2)}/kg</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>

                                <h3 class="text-xl font-semibold text-yellow-800 mb-4">Vegetables</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                    ${vegetablesPrices.map((data, index) => `
                                        <div class="flex items-center bg-yellow-100 p-3 rounded-lg shadow-sm">
                                            <span class="w-12 h-12 rounded-full flex items-center justify-center text-center text-xs font-semibold mr-4 border border-yellow-300 ${getItemColorClasses(data.item)}">
                                                ${data.item}
                                                </span>
                                                <div class="flex-grow">
                                                    <span class="font-medium text-gray-700 block">${data.item}</span>
                                                    <span class="font-semibold text-yellow-700">â‚¹${data.price.toFixed(2)}/kg</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="col-span-full text-center text-gray-500">No current price data available.</div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            break;
        case 'analysis':
            html = `
                <div class="space-y-8 animate-fade-in">
                    <div class="bg-gradient-to-br from-white via-indigo-50 to-purple-50 border-indigo-300 shadow-2xl card-animate">
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-t-lg p-4">
                            <h2 class="text-3xl font-bold flex items-center gap-3">
                                ${BarChartIcon()}
                                Advanced Market Analysis
                            </h2>
                        </div>
                        <div class="space-y-8 p-6">
                            <p class="text-xl text-gray-700 font-medium">
                                ðŸ“Š Comprehensive analytical reports powered by AI-driven insights
                            </p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="bg-gradient-to-br from-indigo-100 to-indigo-200 border-indigo-300 shadow-lg transform hover:scale-105 transition-all duration-300">
                                    <div class="p-4">
                                        <h3 class="text-xl text-indigo-800 flex items-center gap-2">
                                            ${TrendingUpIcon()} Seasonal Patterns
                                        </h3>
                                    </div>
                                    <div class="p-4 pt-0">
                                        <p class="text-gray-700 leading-relaxed">
                                            Vegetable prices typically peak during monsoon due to supply disruptions,
                                            while pulses show stability post-harvest with consistent demand patterns.
                                        </p>
                                    </div>
                                </div>

                                <div class="bg-gradient-to-br from-purple-100 to-purple-200 border-purple-300 shadow-lg transform hover:scale-105 transition-all duration-300">
                                    <div class="p-4">
                                        <h3 class="text-xl text-purple-800 flex items-center gap-2">
                                            ðŸ‘¨â€ðŸ”¬ Expert Insights
                                        </h3>
                                    </div>
                                    <div class="p-4 pt-0">
                                        <p class="text-gray-700 leading-relaxed">
                                            "Moderate increase in pulse prices expected next quarter due to
                                            export demand and reduced cultivation area." - Dr. Agricultural Expert
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'news':
            html = `
                <div class="space-y-8 animate-fade-in">
                    <div class="bg-gradient-to-br from-white via-red-50 to-pink-50 border-red-300 shadow-2xl card-animate">
                        <div class="bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-t-lg p-4">
                            <h2 class="text-3xl font-bold flex items-center gap-3">
                                ${NewspaperIcon()}
                                Agricultural News Hub
                            </h2>
                        </div>
                        <div class="p-6">
                            <p class="text-xl text-gray-700 mb-8 font-medium">
                                ðŸ“° Stay updated with the latest agricultural market developments
                            </p>

                            <div class="space-y-6">
                                ${[
                                    {
                                        title: "ðŸ›ï¸ Government Announces New Support Scheme for Farmers",
                                        content: "Revolutionary scheme aimed at boosting crop yields and providing comprehensive financial aid to farmers across the nation.",
                                        date: "July 2, 2025",
                                        category: "Policy"
                                    },
                                    {
                                        title: "ðŸŒ§ï¸ Unexpected Rainfall Boosts Rabi Crop Outlook",
                                        content: "Recent unseasonal rains in key agricultural regions positively impact crop expectations, leading to optimistic market forecasts.",
                                        date: "June 28, 2025",
                                        category: "Weather"
                                    },
                                    {
                                        title: "ðŸŒ Global Pulse Prices See Marginal Dip",
                                        content: "International markets report slight decrease due to increased supply from major producing countries.",
                                        date: "June 20, 2025",
                                        category: "Global Markets"
                                    }
                                ].map((news, index) => `
                                    <div class="bg-gradient-to-r from-red-50 to-pink-50 border-red-200 hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02] animate-fade-in" style="animation-delay: ${index * 200}ms;">
                                        <div class="p-4">
                                            <div class="flex justify-between items-start">
                                                <h3 class="text-xl text-red-800 flex-1">${news.title}</h3>
                                                <span class="px-3 py-1 bg-red-200 text-red-800 rounded-full text-xs font-bold">
                                                    ${news.category}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="p-4 pt-0">
                                            <p class="text-gray-700 mb-3 leading-relaxed">${news.content}</p>
                                            <span class="text-sm text-gray-500 font-medium">ðŸ“… Published: ${news.date}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
    }
    mainContentDiv.innerHTML = html;

    // After rendering, re-attach event listeners for the current page
    attachEventListeners();

    // Special handling for chart on dashboard page
    if (currentPage === 'dashboard' && !loadingForecast && chartData.length > 0) {
        renderChart();
    } else if (currentPage === 'dashboard' && (loadingForecast || chartData.length === 0)) {
        // If chart is not to be rendered, ensure canvas is cleared/hidden
        const canvasContainer = document.getElementById('priceChartCanvas');
        if (canvasContainer) {
            if (priceChart) {
                priceChart.destroy();
                priceChart = null;
            }
            canvasContainer.style.display = 'none'; // Hide canvas
        }
    }
}

// Function to update UI elements based on state
function updateUI() {
    renderContent();
    // Update navigation button active states
    document.querySelectorAll('nav button').forEach(button => {
        // Base classes for all nav buttons
        button.className = 'nav-btn font-semibold px-6 py-3 rounded-xl transition-all duration-300 ease-in-out border border-transparent';
        // Hover classes
        button.classList.add('hover:bg-gradient-to-r', 'hover:from-green-100', 'hover:to-blue-100', 'hover:text-green-800', 'hover:shadow-lg', 'hover:scale-105');

        if (button.id === `nav-${currentPage}`) {
            // Active state classes
            button.classList.add('bg-gradient-to-r', 'from-green-500', 'to-teal-500', 'text-white', 'shadow-xl', 'scale-105');
            button.classList.remove('text-gray-700'); // Remove default text color if active
        } else {
            // Inactive state classes
            button.classList.add('text-gray-700');
            button.classList.remove('bg-gradient-to-r', 'from-green-500', 'to-teal-500', 'text-white', 'shadow-xl', 'scale-105');
        }
    });

    // Update error modal visibility
    const errorModal = document.getElementById('error-modal');
    const errorModalContent = document.getElementById('error-modal-content');
    if (showError) {
        errorModal.classList.remove('hidden');
        setTimeout(() => {
            errorModalContent.classList.remove('scale-95', 'opacity-0');
            errorModalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
    } else {
        errorModalContent.classList.remove('scale-100', 'opacity-100');
        errorModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            errorModal.classList.add('hidden');
        }, 300);
    }
    document.getElementById('error-message').textContent = errorMessage;
}

// Function to attach event listeners to dynamically created elements
function attachEventListeners() {
    // Navigation buttons
    document.getElementById('nav-dashboard').onclick = () => { currentPage = 'dashboard'; updateUI(); };
    document.getElementById('nav-markets').onclick = () => { currentPage = 'markets'; updateUI(); };
    document.getElementById('nav-analysis').onclick = () => { currentPage = 'analysis'; updateUI(); };
    document.getElementById('nav-news').onclick = () => { currentPage = 'news'; updateUI(); };

    // Footer navigation links (newly added)
    document.getElementById('footer-link-dashboard').onclick = (e) => { e.preventDefault(); currentPage = 'dashboard'; updateUI(); };
    document.getElementById('footer-link-markets').onclick = (e) => { e.preventDefault(); currentPage = 'markets'; updateUI(); };
    document.getElementById('footer-link-analysis').onclick = (e) => { e.preventDefault(); currentPage = 'analysis'; updateUI(); };
    document.getElementById('footer-link-news').onclick = (e) => { e.preventDefault(); currentPage = 'news'; updateUI(); };


    // Dashboard controls (only if on dashboard page)
    if (currentPage === 'dashboard') {
        const categorySelect = document.getElementById('category-select');
        if (categorySelect) {
            categorySelect.onchange = (e) => {
                category = e.target.value;
                // Reset item and season when category changes to force re-selection
                item = '';
                selectedSeason = '';
                updateUI();
            };
        }

        const itemSelect = document.getElementById('item-select');
        if (itemSelect) {
            itemSelect.onchange = (e) => {
                item = e.target.value;
                updateUI();
            };
        }

        const seasonSelect = document.getElementById('season-select');
        if (seasonSelect) {
            seasonSelect.onchange = (e) => {
                selectedSeason = e.target.value;
                updateUI();
            };
        }

        const forecastDateInput = document.getElementById('forecastDate-input');
        if (forecastDateInput) {
            forecastDateInput.onchange = (e) => {
                forecastDate = e.target.value;
                updateUI();
            };
        }

        const predictionPeriodSelect = document.getElementById('predictionPeriod-select');
        if (predictionPeriodSelect) {
            predictionPeriodSelect.onchange = (e) => {
                predictionPeriod = e.target.value;
                updateUI();
            };
        }

        const generateForecastBtn = document.getElementById('generate-forecast-btn');
        if (generateForecastBtn) {
            generateForecastBtn.onclick = simulateForecast;
        }
    }

    // Close error modal button
    const closeErrorModalBtn = document.getElementById('close-error-modal');
    if (closeErrorModalBtn) {
        closeErrorModalBtn.onclick = closeErrorModal;
    }
}

// Parse Google JWT - Made globally accessible
function parseJwt(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

// Global functions for login/register modals - Made globally accessible
function openLoginModal() {
    document.getElementById('login-modal').style.display = 'flex';
}
function closeLoginModal() {
    document.getElementById('login-modal').style.display = 'none';
}
function openRegisterModal() {
    document.getElementById('register-modal').style.display = 'flex';
    closeLoginModal(); // Close login if register is opened
}
function closeRegisterModal() {
    document.getElementById('register-modal').style.display = 'none';
}

// Google Sign-In Callback - Made globally accessible and corrected
function handleCredentialResponse(response) {
    const token = response.credential;
    console.log("Encoded JWT ID token (handleCredentialResponse):", token); // Debugging
    const user = parseJwt(token);

    document.getElementById("user-info").innerHTML = `
      Welcome, ${user.name} <img src="${user.picture}" alt="Profile" width="30" style="border-radius:50%;vertical-align:middle;">
    `;
    sessionStorage.setItem("id_token", token); // Store token
    isUserSignedIn = true; // Update flag
    console.log("handleCredentialResponse: isUserSignedIn set to true. Token stored."); // Debugging

    document.getElementById('show-login-btn').style.display = 'none';
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.style.display = 'block';
    }
    closeLoginModal(); // Closes the login modal automatically
    showToast("Successfully signed in as " + user.name, 'success');
}

// Function to handle user logout - Made globally accessible
function signOut() {
    console.log("signOut called."); // Debugging
    if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
        google.accounts.id.disableAutoSelect();
        console.log("Google auto-select disabled."); // Debugging
    }
    
    sessionStorage.removeItem("id_token"); // Remove token
    document.getElementById('user-info').innerHTML = ''; // Clear user info
    isUserSignedIn = false; // Update flag
    console.log("signOut: isUserSignedIn set to false. Token removed."); // Debugging

    document.getElementById('show-login-btn').style.display = 'block';
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.style.display = 'none';
    }
    // --- START: New Logout Refresh Logic ---
    // Reset prediction form and results
    category = '';
    item = '';
    forecastDate = '';
    predictionPeriod = '';
    selectedSeason = '';
    forecastResult = null;
    llmInsight = '';
    chartData = []; // Clear chart data
    loadingForecast = false;
    loadingInsight = false;
    showError = false;
    errorMessage = '';

    // If a chart instance exists, destroy it to clear the canvas
    if (priceChart) {
        priceChart.destroy();
        priceChart = null; // Clear the reference
        const canvasContainer = document.getElementById('priceChartCanvas');
        if (canvasContainer) {
            canvasContainer.style.display = 'none'; // Hide the canvas element
        }
    }
    
    // Force a re-render of the UI to reflect the cleared state
    updateUI(); 
    // --- END: New Logout Refresh Logic ---
    showToast("You have been logged out.", 'info');
}


// Email/password login - corrected to use showToast and proper state update
// This function needs to be globally accessible if `data-callback` or direct `onclick` is used on the form
// However, the current HTML uses `onsubmit` directly, so it needs to be accessible in the global scope
// or directly assigned via `document.getElementById('login-form').onsubmit` inside DOMContentLoaded.
document.getElementById('login-form').onsubmit = function(e) {
    e.preventDefault();
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    
    // Simulate successful login if fields are not empty
    if(email && password) {
        isUserSignedIn = true;
        document.getElementById("user-info").innerHTML = `Welcome, ${email}`; // Update user info display
        sessionStorage.setItem("id_token", "manual_login_token"); // Store a dummy token for manual login
        document.getElementById('show-login-btn').style.display = 'none'; // Hide Sign In button
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) logoutBtn.style.display = 'block'; // Show Logout button
        closeLoginModal();
        showToast("Successfully logged in with email: " + email, 'success');
        console.log("Manual login: isUserSignedIn set to true. Dummy token stored."); // Debugging
    } else {
        showToast("Please enter both email and password.", 'error');
    }
};

// Registration form submission - corrected to use showToast
document.getElementById('register-form').onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById('register-name').value.trim();
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;
    if(name && email && password) {
        // In a real app, send data to backend for registration
        showToast('Registered: ' + name + ' (' + email + ')', 'success');
        closeRegisterModal();
    } else {
        showToast("Please fill all registration fields.", 'error');
    }
};


// Main DOMContentLoaded Listener: All page-wide initializations and event attachments
document.addEventListener('DOMContentLoaded', () => {
    // Initial UI render (sets up page content based on currentPage and initial states)
    currentPrices = generateCurrentPrices(); // Populate currentPrices
    loadingCurrentPrices = false;
    updateUI(); // Initial render to populate dashboard content including current prices

    // Attach listeners for show/hide login/register modals
    const showLoginBtn = document.getElementById('show-login-btn');
    if (showLoginBtn) {
        showLoginBtn.onclick = openLoginModal; // Attach click handler for Sign In button
    }
    
    // Listener for login modal's "Register Now" link
    const loginModalRegisterLink = document.querySelector('#login-modal a[onclick*="openRegisterModal"]');
    if (loginModalRegisterLink) {
        loginModalRegisterLink.onclick = (e) => { e.preventDefault(); openRegisterModal(); };
    }
    
    // Listener for register modal's "Login" link
    const registerModalLoginLink = document.querySelector('#register-modal a[onclick*="openLoginModal"]');
    if (registerModalLoginLink) {
        registerModalLoginLink.onclick = (e) => { e.preventDefault(); closeRegisterModal(); openLoginModal(); };
    }


    // Attach logout functionality to the logout button
    const logoutButton = document.getElementById('logout-btn');
    if (logoutButton) { // Ensure button exists before attaching listener
        logoutButton.onclick = signOut; 
        console.log("DOMContentLoaded: Logout button event listener attached."); // Debugging
    } else {
        console.error("DOMContentLoaded: Logout button not found!"); // Debugging
    }


    // AI Assistant Widget Logic
    const chatLog = document.getElementById('ai-chat-log');
    const chatForm = document.getElementById('ai-chat-form');
    const chatInput = document.getElementById('ai-chat-input');
    const openAssistantBtn = document.getElementById('open-ai-assistant-btn');
    const closeAssistantBtn = document.getElementById('close-assistant-btn');
    const aiAssistantModal = document.getElementById('ai-assistant-modal');
    const micBtn = document.getElementById('mic-btn');


    if (openAssistantBtn && closeAssistantBtn && aiAssistantModal && chatLog && chatForm && chatInput) {
        // Show/Hide the AI Assistant modal
        openAssistantBtn.addEventListener('click', () => {
            aiAssistantModal.style.display = 'block';
            openAssistantBtn.style.display = 'none'; // Hide the open button
            chatLog.scrollTop = chatLog.scrollHeight; // Scroll to bottom on open
        });

        closeAssistantBtn.addEventListener('click', () => {
            aiAssistantModal.style.display = 'none';
            openAssistantBtn.style.display = 'block'; // Show the open button
        });

        // Handle AI chat form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            chatInput.value = ''; // Clear input field

            // Display user message
            chatLog.innerHTML += `<div style="margin-bottom:8px; text-align:right;"><b>You:</b> ${userMessage}</div>`;
            chatLog.scrollTop = chatLog.scrollHeight;

            // Simulate AI response
            const typingIndicator = document.createElement('div');
            typingIndicator.textContent = 'Assistant is typing...';
            typingIndicator.style.cssText = "margin-bottom:8px; color: #888;";
            chatLog.appendChild(typingIndicator);
            chatLog.scrollTop = chatLog.scrollHeight;

            try {
                const response = await fetch('/ai_assistant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: userMessage })
                });
                const data = await response.json();
                
                if (document.getElementById('ai-typing')) { // Check if it still exists
                    document.getElementById('ai-typing').remove();
                }
                chatLog.innerHTML += `<div style="margin-bottom:8px;"><b>Assistant:</b> ${data.answer}</div>`;
                chatLog.scrollTop = chatLog.scrollHeight;
            } catch (error) {
                if (document.getElementById('ai-typing')) { // Check if it still exists
                    document.getElementById('ai-typing').remove();
                }
                chatLog.innerHTML += `<div style="margin-bottom:8px; color:red;"><b>Assistant:</b> Sorry, something went wrong.</div>`;
                console.error('Error fetching AI response:', error);
            }
        });

        // Speech recognition (mic)
        if (micBtn && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.continuous = false; // Set to false for single utterance recognition

            micBtn.addEventListener('click', () => {
                recognition.start();
                micBtn.disabled = true;
                micBtn.style.color = 'red'; // Indicate listening
                chatInput.placeholder = 'Listening...';
            });

            recognition.onresult = event => {
                const transcript = event.results[0][0].transcript;
                chatInput.value = transcript;
            };

            recognition.onerror = event => {
                console.error('Speech recognition error:', event.error);
                showToast("Speech recognition error: " + event.error, 'error'); // Use toast for error
            };

            recognition.onend = () => {
                micBtn.disabled = false;
                micBtn.style.color = ''; // Reset color
                chatInput.placeholder = 'Ask me anything...';
            };
        } else if (micBtn) {
            micBtn.style.display = 'none'; // Hide if not supported
            console.warn('Speech recognition is not supported in this browser.');
        }
    }


    // --- Initial Authentication Status Check on Page Load ---
    const storedToken = sessionStorage.getItem("id_token");
    console.log("DOMContentLoaded: Initial storedToken:", storedToken); // Debugging
    if (storedToken) {
        isUserSignedIn = true;
        try {
            const user = parseJwt(storedToken);
            document.getElementById("user-info").innerHTML = `
              Welcome, ${user.name} <img src="${user.picture}" alt="Profile" width="30" style="border-radius:50%;vertical-align:middle;">
            `;
            console.log("DOMContentLoaded: User info updated from stored token."); // Debugging
        } catch (e) {
            console.error("Error parsing stored token during DOMContentLoaded:", e);
            sessionStorage.removeItem("id_token"); // Clear invalid token
            isUserSignedIn = false;
            console.log("DOMContentLoaded: Invalid token, isUserSignedIn set to false."); // Debugging
        }
    } else {
        isUserSignedIn = false;
        console.log("DOMContentLoaded: No stored token, isUserSignedIn set to false."); // Debugging
    }

    // Update button visibility based on initial sign-in status
    if (isUserSignedIn) {
        document.getElementById('show-login-btn').style.display = 'none';
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) logoutBtn.style.display = 'block';
        console.log("DOMContentLoaded: Showing logout button."); // Debugging
    } else {
        document.getElementById('show-login-btn').style.display = 'block';
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) logoutBtn.style.display = 'none';
        console.log("DOMContentLoaded: Showing sign-in button."); // Debugging
    }
    // --- End Initial Authentication Status Check ---

    // Initial call to attach dynamic event listeners (e.g., dashboard controls)
    attachEventListeners();
});